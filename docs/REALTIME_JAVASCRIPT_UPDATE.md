# üöÄ Real-Time JavaScript Updates

## Overview

The HTML visualization now uses **JavaScript to update in real-time** without requiring page reloads!

### What Changed (November 8, 2025)

**Before:**
- ‚ùå Static HTML generated by Python
- ‚ùå Required full page reload every 5 seconds to update
- ‚ùå Time display frozen at generation time
- ‚ùå No smooth updates

**After:**
- ‚úÖ Dynamic JavaScript updates every second
- ‚úÖ Live clock in the status panel
- ‚úÖ Real-time position calculation in browser
- ‚úÖ No page reloads needed
- ‚úÖ Smooth, continuous updates

## How It Works

### 1. Data Embedded in HTML

When Python generates the HTML, it embeds the channel data as JSON:

```javascript
const channelsData = {
    "1": [
        {
            "pattern": 1,
            "status": [1, 0],
            "time_ms": [998, 998],
            "repeats": 20,
            "pulse": false
        },
        // ... more patterns
    ],
    // ... more channels
};

const startTime = new Date("2025-11-08 20:56:26");
```

### 2. JavaScript Calculations

Every second, JavaScript:

1. **Gets current time:** `const now = new Date();`
2. **Calculates elapsed time:** `const elapsed = now - startTime;`
3. **Determines position:** Walks through patterns to find current state
4. **Updates display:** Changes LED colors, status text, pattern/cycle info

### 3. Live Updates

The `setInterval()` function runs every 1000ms (1 second):

```javascript
function updateDisplay() {
    // Update current time
    document.querySelector('.status-panel h2').textContent = 
        'üî¥ LIVE STATUS - ' + now.toLocaleString();
    
    // Update elapsed time
    // Update each channel's LED indicator
    // Update pattern/cycle information
}

// Update immediately, then every second
updateDisplay();
setInterval(updateDisplay, 1000);
```

## Visual Updates

### Status Panel - Updates Every Second

```
üî¥ LIVE STATUS - 2025-11-08 21:05:47  ‚Üê Ticks every second!

Started: 2025-11-08 21:05:30
Elapsed: 17s                          ‚Üê Updates every second

üü¢ CH1: ON ‚ñà                          ‚Üê LED color changes
   Pattern: 2                         ‚Üê Updates as protocol progresses
   Cycle: 5/10
   Elapsed: 17s                       ‚Üê Live elapsed time
```

### What Updates in Real-Time

| Element | Update Frequency | What Changes |
|---------|------------------|--------------|
| Current Time | 1 second | Clock in header |
| Elapsed Time | 1 second | Time since start |
| LED Indicators | 1 second | üü¢ ON, ‚ö´ OFF, üü† PULSING |
| Status Text | 1 second | "ON ‚ñà", "OFF ‚ñë", "PULSING ‚âà" |
| Pattern Number | 1 second | Which pattern is active |
| Cycle Number | 1 second | Current cycle count |
| Channel Elapsed | 1 second | Time in current channel |

## Technical Details

### Position Calculation Algorithm

```javascript
function calculatePosition(channel, elapsedMs) {
    let totalElapsed = 0;
    
    // Walk through each pattern
    for (let pIdx = 0; pIdx < channel.length; pIdx++) {
        const pattern = channel[pIdx];
        const cycleDuration = pattern.time_ms.reduce((a, b) => a + b, 0);
        const patternDuration = cycleDuration * pattern.repeats;
        
        // Is elapsed time within this pattern?
        if (totalElapsed + patternDuration > elapsedMs) {
            // Yes - calculate which cycle and state
            const patternElapsed = elapsedMs - totalElapsed;
            const currentCycle = Math.floor(patternElapsed / cycleDuration);
            const cycleElapsed = patternElapsed % cycleDuration;
            
            // Find which state within the cycle
            let stateElapsed = 0;
            let currentState = 0;
            for (let s = 0; s < pattern.time_ms.length; s++) {
                if (stateElapsed + pattern.time_ms[s] > cycleElapsed) {
                    currentState = s;
                    break;
                }
                stateElapsed += pattern.time_ms[s];
            }
            
            return {
                elapsed_ms: elapsedMs,
                current_pattern: pIdx,
                current_cycle: currentCycle,
                current_state: currentState,
                status: pattern.status[currentState],
                is_pulsing: pattern.pulse,
                completed: false
            };
        }
        
        totalElapsed += patternDuration;
    }
    
    // Protocol completed
    return { completed: true, /* ... */ };
}
```

### Time Formatting

```javascript
function formatTime(ms) {
    if (ms < 1000) return Math.round(ms) + 'ms';
    if (ms < 60000) return (ms / 1000).toFixed(2) + 's';
    if (ms < 3600000) return (ms / 60000).toFixed(2) + 'min';
    return (ms / 3600000).toFixed(2) + 'hr';
}
```

## Benefits

### ‚úÖ Advantages

1. **No Page Reloads**
   - Smooth, continuous updates
   - No flashing or jumping
   - Better user experience

2. **Accurate Time Display**
   - Clock shows real current time
   - Updates every second
   - No delays from page generation

3. **Better Performance**
   - No server/Python execution needed
   - Runs entirely in browser
   - Lower resource usage

4. **Responsive**
   - Instant feedback
   - No network delay
   - Works offline after initial load

### üéØ Use Cases

1. **Long-Running Protocols**
   - Watch progress over hours
   - See exact current position
   - Monitor channel states

2. **Protocol Debugging**
   - Verify timing accuracy
   - Check state transitions
   - Confirm pattern sequences

3. **Documentation**
   - Share HTML file
   - Recipients see live replay
   - No Python needed to view

## Example Output

### When Executing

```bash
python protocol_parser.py
# Select: examples/my_protocol.txt
```

**Generated HTML includes:**
- Embedded channel data (JSON)
- Start time: `new Date("2025-11-08 21:05:30")`
- JavaScript update code
- **Opens in browser, starts ticking immediately**

### When Previewing

```bash
python preview_protocol.py examples/my_protocol.txt
```

**Generated HTML includes:**
- Embedded channel data (JSON)
- Start time: `null` (no real-time tracking)
- JavaScript update code (but only updates clock)
- **Shows structure without position tracking**

## Browser Compatibility

Works in all modern browsers:

| Browser | Version | Status |
|---------|---------|--------|
| Chrome | 90+ | ‚úÖ Full support |
| Firefox | 88+ | ‚úÖ Full support |
| Safari | 14+ | ‚úÖ Full support |
| Edge | 90+ | ‚úÖ Full support |

**Required Features:**
- ES6 JavaScript (const, let, arrow functions)
- `setInterval()`
- `Date` object
- `JSON` parsing
- DOM manipulation

## Testing

### Test 1: Current Time Updates

1. Open the HTML file
2. Watch the status panel header
3. **Expected:** Time updates every second

```
üî¥ LIVE STATUS - 2025-11-08 21:05:30  ‚Üê Wait 1 second
üî¥ LIVE STATUS - 2025-11-08 21:05:31  ‚Üê Time changed!
üî¥ LIVE STATUS - 2025-11-08 21:05:32  ‚Üê Still updating
```

### Test 2: Elapsed Time Updates

1. Execute a protocol with start time
2. Open the HTML file
3. **Expected:** Elapsed time increases every second

```
Elapsed: 10s  ‚Üê Wait 1 second
Elapsed: 11s  ‚Üê Incremented!
Elapsed: 12s  ‚Üê Still counting
```

### Test 3: LED State Changes

1. Execute a protocol with short patterns (1-2 seconds)
2. Watch the LED indicators
3. **Expected:** LEDs change color as states transition

```
üü¢ CH1: ON ‚ñà   ‚Üê Wait for state to end
‚ö´ CH1: OFF ‚ñë  ‚Üê Changed to OFF!
üü¢ CH1: ON ‚ñà   ‚Üê Back to ON
```

### Test 4: Pattern/Cycle Updates

1. Execute protocol
2. Watch pattern and cycle numbers
3. **Expected:** Numbers increment as protocol progresses

```
Pattern: 1, Cycle: 1/20  ‚Üê Wait for cycle to complete
Pattern: 1, Cycle: 2/20  ‚Üê Cycle incremented!
Pattern: 1, Cycle: 3/20  ‚Üê Continuing...
```

## Debugging

### Check Browser Console

Press F12 to open developer tools, then check Console tab:

**No errors = Working correctly!**

**Common errors:**

```javascript
// Error: channelsData is not defined
// Fix: Regenerate HTML with updated Python script

// Error: startTime is not defined  
// Fix: Check start time parameter was provided

// Error: Cannot read property 'textContent'
// Fix: Check HTML structure matches expected
```

### Verify Data Embedded

In browser console:

```javascript
// Check if data is present
console.log(channelsData);
// Should show: {1: [...], 2: [...], ...}

console.log(startTime);
// Should show: Date object or null

// Test position calculation
console.log(calculatePosition(channelsData[1], 10000));
// Should show position object
```

## Comparison: Old vs New

### Old Approach (Page Reload)

```javascript
// Reload entire page every 5 seconds
setTimeout(() => {
    location.reload();
}, 5000);
```

**Problems:**
- ‚ùå Time display frozen between reloads
- ‚ùå 5-second delay before updates
- ‚ùå Page flash on reload
- ‚ùå Loses scroll position
- ‚ùå Regenerates entire page

### New Approach (JavaScript Updates)

```javascript
// Update display every second
function updateDisplay() {
    // Update time
    // Recalculate positions
    // Update UI elements
}

setInterval(updateDisplay, 1000);
```

**Benefits:**
- ‚úÖ Continuous time updates
- ‚úÖ 1-second update frequency
- ‚úÖ Smooth transitions
- ‚úÖ Maintains scroll position
- ‚úÖ Only updates changed elements

## Future Enhancements

Possible improvements:

1. **Interactive Controls**
   - Pause/resume updates
   - Adjust update frequency
   - Jump to specific time

2. **Visual Timeline**
   - Animated progress bar
   - Scroll to current position
   - Highlight active patterns

3. **Export Data**
   - Download current state
   - Export as CSV
   - Generate report

4. **Multiple Protocols**
   - Compare different runs
   - Overlay timelines
   - Diff viewer

---

**Updated:** November 8, 2025  
**Version:** 2.2.1  
**Status:** ‚úÖ Production Ready

**Key Improvement:** Real-time updates now happen **every second** in JavaScript, not every 5 seconds with page reloads!
